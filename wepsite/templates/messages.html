{% extends "base.html" %}

{% block title %}Messages - {{ pet.name if pet and not pet.is_deleted else 'Archived Pet' }}{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/messages.css') }}">
{% endblock %}

{% block content %}
<!-- Error/Success Toast Messages -->
<div id="errorToast" class="error-toast"></div>
<div id="successToast" class="success-toast"></div>

<!-- Connection Status Indicator -->
<div id="connectionStatus" class="connection-status status-disconnected" style="display: none;">
    üî¥ Disconnected
</div>

<!-- Hero Section -->
<section class="messages-hero">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="hero-content">
                    <h1 class="hero-title">Chat Messages</h1>
                    <p class="hero-subtitle">Connect with potential adopters and pet owners</p>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Main Messages Section -->
<section class="main-section">
    <div class="container">
        <!-- Floating decorative elements -->
        <div class="floating-element">üí¨</div>
        <div class="floating-element">üê±</div>
        <div class="floating-element">‚ù§Ô∏è</div>
        
        <div class="row justify-content-center">
            <div class="col-md-10 col-lg-8">
                <div class="chat-container">
                    <!-- Chat Header -->
                    <div class="chat-header">
                        <div class="pet-info">
                            <div class="pet-details">
                                <h5 class="pet-name">
                                    {% if application.pet and not application.pet.is_deleted %}
                                        <a href="{{ url_for('views.pet_detail', pet_id=application.pet.id) }}" class="pet-link">
                                            üêæ {{ application.pet.name }} ({{ application.pet.breed }})
                                        </a>
                                        <small class="poster-info">
                                            Posted by {{ application.pet.poster.first_name }}
                                        </small>
                                    {% else %}
                                        <span class="archived-pet">Archived Pet Conversation</span>
                                    {% endif %}
                                </h5>
                                {% if application.pet and application.pet.is_deleted %}
                                    <small class="unavailable-notice">This pet is no longer available</small>
                                {% endif %}
                            </div>
                            <div class="status-badge">
                                <span class="badge status-{{ application.status }}">
                                    {% if application.status == 'approved' %}<i class="fa-regular fa-thumbs-up"></i>{% endif %}
                                    {% if application.status == 'pending' %}<i class="fa-solid fa-hourglass-half"></i>{% endif %}
                                    {% if application.status == 'rejected' %}<i class="fa-solid fa-square-xmark"></i>{% endif %}
                                    {% if application.status == 'archived' %}<i class="fa-solid fa-box-archive"></i>{% endif %}
                                    {{ application.status|title }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Application Details (Admin Only) -->
                    {% if current_user.is_admin and application.answers %}
                    <div class="application-details">
                        <h6 class="details-title">Application Details</h6>
                        <div class="details-content">
                            {% set answers = application.answers|from_json %}
                            <div class="details-grid">
                                {% for question, answer in answers.items() %}
                                    <div class="detail-item">
                                        <strong>{{ question|replace('_', ' ')|title }}:</strong>
                                        <span>{{ answer }}</span>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Message Count -->
                    <div class="message-count" id="messageCount">
                        {{ messages|length }} message{{ 's' if messages|length != 1 else '' }}
                    </div>

                    <!-- Messages Container -->
                    <div class="messages-container" id="messagesContainer">
                        {% for msg in messages %}
                            <div class="message-wrapper" data-message-id="{{ msg.id }}" data-sequence="{{ msg.sequence_number }}" data-client-id="{{ msg.client_id }}">
                                <div class="message {{ 'message-sent' if msg.sender_id == current_user.id else 'message-received' }}">
                                    <div class="message-bubble">
                                        <div class="message-header">
                                            <span class="sender-name">{{ msg.sender.first_name }}</span>
                                            <span class="message-time">{{ msg.timestamp.strftime('%b %d, %I:%M %p') }}</span>
                                            {% if msg.sender_id == current_user.id %}
                                                <span class="read-status">
                                                    {% if msg.is_read %}
                                                        <i class="read-icon read" title="Read">‚úì‚úì</i>
                                                    {% else %}
                                                        <i class="read-icon delivered" title="Delivered">‚úì</i>
                                                    {% endif %}
                                                </span>
                                            {% endif %}
                                        </div>
                                        <p class="message-content">{{ msg.content }}</p>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    <!-- Typing Indicator -->
                    <div class="typing-indicator" id="typingIndicator">
                        Someone is typing...
                    </div>

                    <!-- Message Input -->
                    <div class="chat-footer">
                        {% if application.status == 'archived' or (application.pet and application.pet.is_deleted) %}
                            <div class="archived-notice">
                                <i class="archive-icon fa-solid fa-box-archive"></i>
                                <span>This application is archived and cannot be modified.</span>
                            </div>
                        {% else %}
                            <form id="message-form" method="POST" action="{{ url_for('views.messages', application_id=application.id) }}" class="message-form">
                                <input type="hidden" name="form_id" value="{{ form_id }}">
                                <div class="input-wrapper">
                                    <input type="text" 
                                           name="message" 
                                           class="message-input" 
                                           placeholder="Type your message..." 
                                           maxlength="1000"
                                           required>
                                    <button type="submit" class="send-btn" id="sendBtn">
                                        <span class="btn-text">Send</span>
                                        <span class="btn-icon"><i class="fa-solid fa-paper-plane"></i></span>
                                    </button>
                                </div>
                                
                                <!-- Character counter -->
                                <div class="char-counter">
                                    <span id="charCount">0</span>/1000
                                </div>

                                {% if current_user.is_admin and application.pet.posted_by == current_user.id and application.status == 'pending' %}
                                <div class="quick-replies">
                                    <button type="button" class="quick-reply-btn approve-btn" data-reply="approved">
                                        Approve Application
                                    </button>
                                    <button type="button" class="quick-reply-btn info-btn" data-reply="questions">
                                        Request More Info
                                    </button>
                                    <button type="button" class="quick-reply-btn reject-btn" data-reply="rejected">
                                        Need More Details
                                    </button>
                                </div>
                                {% endif %}
                            </form>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    // Add these variables before loading the external JS file
    const messageCount = {{ messages|length }};
    const currentSequence = {{ messages[-1].sequence_number if messages else 0 }};
    const currentUserId = {{ current_user.id }};
    const currentUserName = '{{ current_user.first_name }}';
    const applicationId = '{{ application.id }}';
</script>
<script src="{{ url_for('static', filename='js/messages.js') }}"></script>
{% endblock%}